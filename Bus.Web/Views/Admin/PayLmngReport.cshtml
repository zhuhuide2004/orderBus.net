@{
    ViewBag.Title = "PayLmngReport";
    Layout = "~/Views/Shared/AdminLayout.cshtml";
}
@model PagedList<Bus.Data.PayLmngView>
@section HeadScript{
    <script language="javascript" type="text/javascript" src="/Content/admin/js/formvalidator.js" charset="UTF-8"></script>
    <script language="javascript" type="text/javascript" src="/Content/admin/js/formvalidatorregex.js" charset="UTF-8"></script>
    <script type="text/javascript" src="/Content/layer/layer.min.js?v=1.6.0"></script>
    <script language="JavaScript" type="text/javascript" src="/Content/My97DatePicker/WdatePicker.js"></script>

    <script type="text/javascript">

        $(document).ready(function () {

            $.formValidator.initConfig({
                formID: "myform", mode: 'AutoTip',
                onError: function (msg, obj) {
                    layer.alert('错误啦！' + msg, 3, !1);
                },
                ajaxForm: {
                    type: 'POST',
                    dataType: 'json',
                    buttons: $("#Lock"),
                    url: "PayLmngLock",
                    success: function (result) {
                        if (result.success) {
                            alert('锁定成功');
                            /*
                            layer.alert('修改成功', function (index) {
                                layer.close(index);
                                parent.layer.close();
                                parent.location.href = "BusList";
                            }, '提示信息', function (index) {
                                layer.close(index);
                                window.location.href = "BusList";
                            });
                            */
                        }
                        else {
                            layer.alert('发生错误，操作不成功！', 3, !1);
                        }
                        return false;

                    }
                },
                submitAfterAjaxPrompt: '有数据正在异步验证，请稍等...'
            });
        });

        function GoSearch() {

            var LineName = $("#LineName").val();//线路
            var PayTime = $("#PayTime").val();//查询期间
            var Names = $("#Names").val();//车长姓名
            var MangerID = $("#MangerID").val();//经手人
            var LockFlag = $("#LockFlag").val();//状态

            var u = "PayLmngReport?LineName=" + LineName + "&PayTime=" + PayTime + "&Names=" + Names +
                    "&MangerID=" + MangerID + "&LockFlag=" + LockFlag;
            window.location.href = u;
        }

        //导出Excel
        function ToExcel() {
            var url = "@(Request.Url)";
            url = url.replace("PayLmngReport", "ToExcelPayLmngReport");
            window.location.href = url;
        }

        //function LockPay() {
        //        $.formValidator.initConfig({
        //            formID: "myform", mode: 'AutoTip',
        //            onError: function (msg, obj) {
        //                layer.alert('错误啦！' + msg, 3, !1);
        //            },
        //            ajaxForm: {
        //                type: 'POST',
        //                dataType: 'json',
        //                buttons: $("#Lock"),
        //                url: "PayLock",
        //                success: function (result) {
        //                    if (result.success) {
        //                        alert('锁定成功');
        //                        /*
        //                        layer.alert('修改成功', function (index) {
        //                            layer.close(index);
        //                            parent.layer.close();
        //                            parent.location.href = "BusList";
        //                        }, '提示信息', function (index) {
        //                            layer.close(index);
        //                            window.location.href = "BusList";
        //                        });
        //                        */
        //                    }
        //                    else {
        //                        layer.alert('发生错误，操作不成功！', 3, !1);
        //                    }
        //                    return false;

        //                }
        //            },
        //            submitAfterAjaxPrompt: '有数据正在异步验证，请稍等...'
        //        });
        //}
    </script>
}
<div class="subnav">
    <div class="content-menu ib-a blue line-x">
        <a href="javascript:;;" class="on"><em>车长收费报表</em></a>
    </div>
</div>
<style type="text/css">
    html {
        _overflow-y: scroll;
    }
</style>

<form name="myform" id="myform" action="@(Request.Url)" method="post">
    @{var mList = Bus.Data.ManagerDB.ManagerList();}
    <table width="100%" cellspacing="0" class="search-form">
        <tbody>

            @{ var LineName = TheCMS.Common.iRequest.GetQueryString("LineName");}
            @{ var PayTime = TheCMS.Common.iRequest.GetQueryString("PayTime");}
            @{ var Names = TheCMS.Common.iRequest.GetQueryString("Names");}
            @{ var MangerID = TheCMS.Common.iRequest.GetQueryString("MangerID");}
            @{ var LockFlag = TheCMS.Common.iRequest.GetQueryString("LockFlag");}

            <tr>
                <td>
                    <div class="explain-col">
                        线路
                    <input type="text" id="LineName" name="LineName" value="@(LineName)" style="width:90px;"  class="input-text" required/>
                        查询期间
                    <input type="text" id="PayTime" name="PayTime" value="@(PayTime)" style="width:90px;"  class="input-text" />
                        车长姓名
                    <input type="text" id="Names" name="Names" value="@(Names)" style="width:90px;"  class="input-text" />
                        
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <input type="submit" id="Lock" name="Lock" class="button" value="锁定缴费">
                @*<input type="button" id="Lock" name="Lock" class="button" onclick="LockPay()" value="锁定缴费">*@
                        @*<input type="button" id="Lock" name="Lock" class="button" onclick="Lock()" value="锁定缴费">*@
                        <input type="button" name="OutPut" class="button" onclick="ToExcel()" value="导出">
                    </div>
                </td>
            </tr>

            <tr>
                <td>
                    <div class="explain-col">
                        经手人 
                    <select id="MangerID" name="MangerID">
                        <option value="0">请选择</option>
                        @foreach (var item in mList)
                        {
                            <option value="@(item.ID)"  @(Model != null ? item.ID.ToString() == MangerID ? " selected" : "" : "")>@(item.RealName)</option>
                        }
                    </select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        状态
                    <select id="LockFlag">
                        <option value="" @(LockFlag == "" ? " selected" : "")>全部</option>
                        <option value="00" @(LockFlag == "00" ? " selected" : "")>未锁定</option>
                        <option value="01" @(LockFlag == "01" ? " selected" : "")>已锁定</option>
                    </select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="button" name="Search" class="button" onclick="GoSearch()" value="查询">
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="pad_10">
        <div class="bk10"></div>
        <div class="table-list">

            <table width="100%" cellspacing="0">
                <thead>
                <tr>
                    <th align='center' width="90">线路信息</th>
                    <th align='center' width="120">期间</th>
                    <th align='center' width="90">车长姓名</th>
                    <th align='center' width="45">性别</th>
                    <th align="center" width="120">电话</th>
                    <th align='center' width="90">应收款</th>
                    <th align='center' width="90">实收款</th>
                    <th align='center' width="90">单次款</th>
                    <th align='center' width="90">经手人</th>
                    <th align='center' width="120">备注</th>
                    <th align='center' width="140">缴费时间</th>
                    <th align='center' width="90">状态</th>
                </tr>
                    </thead>
                

                <tbody>
                    @if (Model.Count == 0)
                    { 
                        <tr>
                            <td colspan="9">没有任何数据</td>
                        </tr>
                    }
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td align='center'>@(item.LineName)</td>
                            <td align='center'>@(item.PayTime.ToString("yyyy年MM月"))</td>
                            <td align='center'>@(item.Names)</td>
                            <td align='center'>@(item.Sex == 1 ? "女" : item.Sex == 2 ? "男" : "")</td>
                            <td align='center'>@(item.Phone)</td>
                            <td align='center'>
                                @{var paymoney = item.PayMoneyYS.ToString();}
                                @(paymoney.Length>0? paymoney.Remove(paymoney.IndexOf(".")) : "")
                            </td>
                            <td align='center'>
                                @{paymoney = item.PayMoneySS.ToString();}
                                @(paymoney.Length>0? paymoney.Remove(paymoney.IndexOf(".")) : "")
                            </td>
                            <td align='center'>
                                @{paymoney = item.PayMoneyDC.ToString();}
                                @(paymoney.Length>0? paymoney.Remove(paymoney.IndexOf(".")) : "")
                            </td> 
                            <td align='center'>@(item.ManagerName)</td>
                            <td align='center'>@(item.Ect)</td>
                            <td align='center'>@(item.PayTime)</td>
                            <td align='center'>@(item.LockFlag == "01" ? "已锁定" : "")</td>
                        </tr>                    
                    }

                </tbody>
                @using (Html.BeginForm("PayLock", "Admin"))//ActionName，ControllerName
                {
                    for (int i = 0; i < Model.Count; i++)
                    {
                    <tr style="height:0px;">
                        <td style="height:0px;">@Html.HiddenFor(x => x[i].ID)</td>
                        <td>@Html.HiddenFor(x => x[i].LineName)</td>
                        <td>@Html.HiddenFor(x => x[i].PayTime)</td>
                        <td>@Html.HiddenFor(x => x[i].Names)</td>
                        <td>@Html.HiddenFor(x => x[i].Sex)</td>
                        <td>@Html.HiddenFor(x => x[i].Phone)</td>
                        <td>@Html.HiddenFor(x => x[i].PayMoneyYS)</td>
                        <td>@Html.HiddenFor(x => x[i].PayMoneySS)</td>
                        <td>@Html.HiddenFor(x => x[i].PayMoneyDC)</td>
                        <td>@Html.HiddenFor(x => x[i].ManagerName)</td>
                        <td>@Html.HiddenFor(x => x[i].Ect)</td>
                        <td>@Html.HiddenFor(x => x[i].PayTime)</td>
                        <td>@Html.HiddenFor(x => x[i].LockFlag)</td>
                    </tr>
                    }
                }
            </table>

            <div id="pages">
                @Html.Pager(Model, new PagerOptions { PageIndexParameterName = "page", CurrentPagerItemWrapperFormatString = "<span class=\"curpage\">{0}</span>", NumericPagerItemWrapperFormatString = "<span class=\"item\">{0}</span>", CssClass = "pages", AutoHide = false, SeparatorHtml = "" })
            </div>
        </div>
    </div>
</form>

